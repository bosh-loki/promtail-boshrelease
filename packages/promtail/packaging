#!/usr/bin/env bash
set -euo pipefail

# Copy common utils
mkdir -p ${BOSH_INSTALL_TARGET}/common
cp -a ${BOSH_COMPILE_TARGET}/common/* ${BOSH_INSTALL_TARGET}/common

# shellcheck source=../../src/build/bosh-go.bash
source build/bosh-go.bash

mkdir -p "${GOPATH}/src/github.com/grafana/loki"

cp -a loki/. "${GOPATH}/src/github.com/grafana/loki"

go build -o "${BOSH_INSTALL_TARGET}/bin/promtail" github.com/grafana/loki/cmd/promtail

# clean up source artifacts
rm -rf "${BOSH_INSTALL_TARGET}/src" "${BOSH_INSTALL_TARGET}/pkg"
